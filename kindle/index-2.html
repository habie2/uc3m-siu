<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector EPUB con Guardado</title> {/* Updated title */}
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        /* Custom styles (same as before) */
        body { font-family: 'Inter', sans-serif; }
        #viewer {
            height: calc(100vh - 180px); width: 100%; max-width: 800px;
            margin: 0 auto; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem; overflow: hidden;
        }
        .action-button {
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed;
        }
        #file-input {
            @apply block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer;
        }
        .epub-arrow { display: none !important; }
        /* Style for highlights - Adding cursor pointer for removal */
        .epub-highlight {
             mix-blend-mode: multiply;
             cursor: pointer; /* Indicate clicking is possible */
        }
        /* Style for highlight removal confirmation (optional) */
        .highlight-confirm-dialog {
             /* Basic styling if needed, but using native confirm() for simplicity */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex flex-col items-center p-6">

    <h1 class="text-3xl font-bold text-gray-800 mb-6">Lector EPUB Sencillo (con Guardado)</h1>

    <div class="mb-6 w-full max-w-md bg-white p-4 rounded-lg shadow">
        <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Elige un archivo EPUB:</label>
        <input type="file" id="file-input" accept=".epub">
        <p id="file-info" class="text-xs text-gray-500 mt-2"></p>
    </div>

    <div id="viewer-container" class="w-full max-w-3xl mb-4">
        <div id="viewer">
            <p class="text-center text-gray-500 p-10">Por favor, selecciona un archivo EPUB para empezar a leer.</p>
        </div>
    </div>

    <div id="controls" class="flex justify-center items-center space-x-4 w-full max-w-md flex-wrap gap-y-2">
        <button id="prev" class="action-button">Anterior</button>
        <button id="highlight-button" class="action-button">Subrayar Selección</button>
        <button id="next" class="action-button">Siguiente</button>
    </div>

    <script>
        console.log("Script iniciado.");

        // --- Constants ---
        const HIGHLIGHT_STORAGE_KEY = 'epubReaderHighlights'; // Key for localStorage

        // --- State Variables ---
        let book = null;
        let rendition = null;
        let currentSelectionCfiRange = null;
        let currentBookId = null; // To store the identifier (filename) of the current book

        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input');
        const viewer = document.getElementById('viewer');
        const prevButton = document.getElementById('prev');
        const nextButton = document.getElementById('next');
        const highlightButton = document.getElementById('highlight-button');
        const fileInfo = document.getElementById('file-info');
        // const viewerContainer = document.getElementById('viewer-container'); // Not currently used

        console.log("Elementos DOM obtenidos.");

        // --- LocalStorage Helper Functions ---

        /**
         * Retrieves all highlights from localStorage.
         * @returns {object} An object where keys are book IDs and values are arrays of CFI strings.
         */
        function getHighlightsFromStorage() {
            try {
                const storedData = localStorage.getItem(HIGHLIGHT_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : {};
            } catch (error) {
                console.error("Error al leer subrayados del localStorage:", error);
                return {}; // Return empty object on error
            }
        }

        /**
         * Saves the entire highlights data object to localStorage.
         * @param {object} data - The highlights data object.
         */
        function saveHighlightsToStorage(data) {
            try {
                localStorage.setItem(HIGHLIGHT_STORAGE_KEY, JSON.stringify(data));
                console.log("Subrayados guardados en localStorage.");
            } catch (error) {
                console.error("Error al guardar subrayados en localStorage:", error);
                // Notify user? Could be due to storage limits.
                alert("No se pudieron guardar los subrayados. Es posible que el almacenamiento esté lleno.");
            }
        }

        /**
         * Adds a highlight CFI range for a specific book ID to storage.
         * @param {string} bookId - The identifier of the book.
         * @param {string} cfiRange - The CFI range string of the highlight.
         */
        function addHighlightToStorage(bookId, cfiRange) {
            if (!bookId || !cfiRange) return;
            const highlights = getHighlightsFromStorage();
            if (!highlights[bookId]) {
                highlights[bookId] = [];
            }
            // Avoid duplicates
            if (!highlights[bookId].includes(cfiRange)) {
                highlights[bookId].push(cfiRange);
                saveHighlightsToStorage(highlights);
                console.log(`Subrayado añadido para ${bookId}: ${cfiRange}`);
            } else {
                 console.log(`Subrayado duplicado ignorado para ${bookId}: ${cfiRange}`);
            }
        }

        /**
         * Removes a highlight CFI range for a specific book ID from storage.
         * @param {string} bookId - The identifier of the book.
         * @param {string} cfiRange - The CFI range string of the highlight to remove.
         */
        function removeHighlightFromStorage(bookId, cfiRange) {
            if (!bookId || !cfiRange) return;
            const highlights = getHighlightsFromStorage();
            if (highlights[bookId]) {
                const initialLength = highlights[bookId].length;
                highlights[bookId] = highlights[bookId].filter(cfi => cfi !== cfiRange);
                if (highlights[bookId].length < initialLength) {
                     saveHighlightsToStorage(highlights);
                     console.log(`Subrayado eliminado de ${bookId}: ${cfiRange}`);
                     return true; // Indicate removal happened
                }
            }
            console.log(`Subrayado no encontrado para eliminar en ${bookId}: ${cfiRange}`);
            return false; // Indicate removal didn't happen
        }

        /**
         * Loads and applies highlights for the current book from storage.
         */
        function applySavedHighlights() {
            if (!rendition || !currentBookId) return;
            const highlights = getHighlightsFromStorage();
            const bookHighlights = highlights[currentBookId] || [];
            console.log(`Aplicando ${bookHighlights.length} subrayados guardados para ${currentBookId}`);
            bookHighlights.forEach(cfiRange => {
                try {
                    // Re-apply highlight using the same parameters as when creating
                    rendition.annotations.highlight(
                        cfiRange,
                        {}, // data
                        (e, annotation) => handleHighlightClick(annotation), // click handler
                        "hl", // class
                        {"fill": "yellow", "fill-opacity": "0.4", "pointer-events": "auto"} // style
                    );
                } catch (error) {
                    console.error(`Error al aplicar subrayado guardado (${cfiRange}):`, error);
                    // Optionally remove invalid CFI from storage?
                    // removeHighlightFromStorage(currentBookId, cfiRange);
                }
            });
        }

        /**
         * Handles clicks on existing highlights (for removal).
         * @param {object} annotation - The annotation object from epub.js.
         */
        function handleHighlightClick(annotation) {
            console.log("Subrayado clickeado:", annotation);
            // epub.js annotation object structure might vary, find CFI reliably
            const cfiRange = annotation.cfiRange || (annotation.location && annotation.location.cfi);

            if (cfiRange && currentBookId) {
                 // Use confirm() for simplicity
                 if (confirm("¿Quieres eliminar este subrayado?")) {
                    try {
                        rendition.annotations.remove(cfiRange, 'highlight');
                        console.log("Subrayado eliminado de la vista:", cfiRange);
                        removeHighlightFromStorage(currentBookId, cfiRange);
                    } catch (error) {
                        console.error("Error al eliminar subrayado de la vista:", error);
                    }
                 }
            } else {
                 console.warn("No se pudo obtener el CFI del subrayado clickeado para eliminarlo.");
            }
        }


        // --- Event Listener for File Input ---
        fileInput.addEventListener('change', function(e) {
            console.log("Evento 'change' en fileInput detectado.");
            const file = e.target.files[0];
            if (file && file.name.endsWith('.epub')) {
                currentBookId = file.name; // Use filename as book identifier
                console.log(`Archivo EPUB válido seleccionado: ${currentBookId}`);

                if (book) { book.destroy(); } // Clean up previous book
                viewer.innerHTML = '<p class="text-center text-gray-500 p-10 animate-pulse">Cargando libro...</p>';
                fileInfo.textContent = `Cargando: ${currentBookId}`;
                currentSelectionCfiRange = null;
                updateHighlightButtonState();

                const reader = new FileReader();
                reader.onload = function(event) {
                    console.log("FileReader 'onload' ejecutado.");
                    const arrayBuffer = event.target.result;
                    try {
                        book = ePub(arrayBuffer);
                        console.log("Libro cargado:", book);

                        rendition = book.renderTo("viewer", { /* options */ width: "100%", height: "100%", flow: "paginated" });
                        console.log("Rendition creada:", rendition);

                        rendition.display().then(() => {
                            console.log("Rendition.display() completado.");
                            fileInfo.textContent = `Cargado: ${currentBookId}`;
                            updateNavButtons();
                            updateHighlightButtonState();

                            // --- Apply saved highlights for this book ---
                            applySavedHighlights();

                            // --- Add Rendition-Specific Listeners ---
                            console.log("Añadiendo listeners específicos de la rendition.");
                            rendition.on('selected', (cfiRange, contents) => {
                                currentSelectionCfiRange = cfiRange;
                                console.log("Evento 'selected':", cfiRange);
                                updateHighlightButtonState();
                            });
                            rendition.on('displayed', (view) => {
                                const doc = view.document || view.contentDocument;
                                if (doc) {
                                    doc.addEventListener('mouseup', () => { setTimeout(() => {
                                        const selection = doc.getSelection();
                                        if ((!selection || selection.isCollapsed) && currentSelectionCfiRange) {
                                            console.log("Evento 'mouseup' en iframe: Selección eliminada.");
                                            currentSelectionCfiRange = null; updateHighlightButtonState();
                                        }}, 50);
                                    });
                                }
                            });
                            rendition.on("locationChanged", (location) => {
                                console.log("Evento 'locationChanged':", location.start.cfi);
                                updateNavButtons();
                                currentSelectionCfiRange = null; updateHighlightButtonState();
                            });
                            rendition.on("keyup", (event) => {
                                if(event.keyCode == 37){ rendition.prev(); }
                                if(event.keyCode == 39){ rendition.next(); }
                            });

                        }).catch(err => { console.error("Error en rendition.display():", err); /* ... error display ... */ });
                    } catch (loadError) { console.error("Error al cargar/renderizar:", loadError); /* ... error display ... */ }
                };
                reader.onerror = (event) => { console.error("Error en FileReader:", event.target.error); /* ... error display ... */ };
                reader.readAsArrayBuffer(file);
            } else {
                console.warn("Archivo no válido o no seleccionado.");
                fileInfo.textContent = "Por favor, selecciona un archivo .epub válido.";
                viewer.innerHTML = '<p class="text-center text-gray-500 p-10">Por favor, selecciona un archivo EPUB.</p>';
                if (book) { book.destroy(); book = null; rendition = null; }
                currentBookId = null; currentSelectionCfiRange = null;
                updateNavButtons(); updateHighlightButtonState();
            }
        });

        // --- Button State Update Functions ---
        function updateNavButtons() { /* ... (same as before, logs removed for brevity) ... */
             if (!rendition || !rendition.location) { prevButton.disabled = true; nextButton.disabled = true; return; }
             prevButton.disabled = rendition.location.atStart; nextButton.disabled = rendition.location.atEnd;
        }
        function updateHighlightButtonState() { /* ... (same as before, logs removed for brevity) ... */
             highlightButton.disabled = !rendition || !currentSelectionCfiRange;
        }

        // --- Global Event Listeners ---
        prevButton.addEventListener('click', () => { console.log("Botón 'Anterior' clickeado."); if (rendition) rendition.prev(); });
        nextButton.addEventListener('click', () => { console.log("Botón 'Siguiente' clickeado."); if (rendition) rendition.next(); });

        highlightButton.addEventListener('click', () => {
            console.log("Botón 'Subrayar Selección' clickeado.");
            if (book && rendition && currentSelectionCfiRange && currentBookId) {
                console.log(`  - Aplicando y guardando subrayado para ${currentBookId}:`, currentSelectionCfiRange);
                try {
                    // Add highlight to view
                    rendition.annotations.highlight(
                        currentSelectionCfiRange,
                        {}, // data
                        (e, annotation) => handleHighlightClick(annotation), // click handler
                        "hl", // class
                        {"fill": "yellow", "fill-opacity": "0.4", "pointer-events": "auto"} // style
                    );

                    // Save highlight to storage
                    addHighlightToStorage(currentBookId, currentSelectionCfiRange);

                     // Clear the selection in the view
                     if (rendition.manager?.views) { rendition.manager.views.forEach(view => { try { view.window?.getSelection()?.removeAllRanges(); } catch(e){} }); }

                    currentSelectionCfiRange = null; // Reset stored range
                    updateHighlightButtonState(); // Disable button again
                } catch (error) {
                     console.error("Error al aplicar el subrayado:", error);
                     alert("Hubo un problema al aplicar el subrayado.");
                }
            } else { console.warn("  - Click ignorado (faltan datos)."); }
        });

        document.addEventListener('keyup', (event) => { /* ... (same as before, logs removed for brevity) ... */
             if (!rendition) return; if (!event.target.matches('input, textarea, button')) { if(event.keyCode == 37){ rendition.prev(); } if(event.keyCode == 39){ rendition.next(); } }
        });

        // --- Initial State Setup ---
        console.log("Estableciendo estado inicial de los botones.");
        updateNavButtons();
        updateHighlightButtonState();
        console.log("Script cargado completamente.");

    </script>

</body>
</html>
